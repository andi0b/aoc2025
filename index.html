<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  </head>
  <body>
    <div class="main">
      <h1>aoc2025 wasm</h1>
      <div id="c"></div>
      <div>
        <label>input</label>
        <button onclick="document.getElementById('input').value = ''">Clear</button>
      </div>
      <textarea id="input" placeholder="Paste your puzzle input here"></textarea>
    </div>
  </body>

  <script>
    const c = document.getElementById('c')

    const createItem = (name, f, memory) => {
      const d = document.createElement('div')
      d.className = 'export'
      c.appendChild(d)

      const l = document.createElement('label')
      l.innerText = 'run'
      d.appendChild(l)

      const b = document.createElement('button')
      b.innerText = name
      d.appendChild(b)

      const lr = document.createElement('label')
      lr.innerText = 'result:'
      d.appendChild(lr)

      const r = document.createElement('input')
      r.setAttribute("disabled", true)
      d.appendChild(r)

      b.onclick = async _ => {
        const inputText = document.getElementById('input').value
        r.value = ''

        const memoryView = new Uint8Array(memory.buffer);
        const encoder = new TextEncoder()
        const result = encoder.encodeInto(inputText, memoryView);
        const length = result.written
        r.value = await f(0, length)
      }
    }

    let wasm;
    const imports = {
      printNumber: (n) => console.log(`printNumber: ${n}`),
      printString: (pointer, len) => {
        const mem = wasm.instance.exports.memory
        const slice = new Uint8Array(mem.buffer, pointer, len)
        const s = new TextDecoder().decode(slice)
        console.log(`printString: ${s}`)
      }
    }

    const loadWasm = async (file, imports) => wasm = await WebAssembly.instantiateStreaming(fetch(file), { env: imports })

    loadWasm('wasm.wasm', imports).then(wasm => {
      for (let prop in wasm.instance.exports) {
        const f = wasm.instance.exports[prop]
        if (typeof f === 'function') {
          createItem(prop, f, wasm.instance.exports.memory)
        }
      }
    })
  </script>

  <style>
    html, body {
      height: 100%;
      margin: 0;
    }
    body {
      font-family: monospace;
    }
    .main {
      display: grid;
      grid-template-rows: auto auto auto 1fr;
      height: 100%;
      padding: 2px;
    }
    h1 {
      margin: 0;
    }
    #c {
      display: grid;
      gap: 4px;
    }
    #input {
      white-space: pre-wrap;
    }
    .export {
      display: grid;
      gap: 6px;
      grid-auto-flow: column;
      grid-auto-columns: min-content;
    }
    .export button {
      min-width: 120px;
    }
  </style>

</html>